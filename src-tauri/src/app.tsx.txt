import { useEffect, useState } from "react";
import { ollamaHealth, ollamaEnsure, listModels, pullModel, generateText } from "./lib/ipc";

export default function App() {
  const [ready, setReady] = useState(false);
  const [models, setModels] = useState<Array<{ model: string }>>([]);
  const [model, setModel] = useState("llama3.2:1b");
  const [prompt, setPrompt] = useState("");
  const [answer, setAnswer] = useState("");
  const [busy, setBusy] = useState(false);

  useEffect(() => {
    (async () => {
      await ollamaEnsure();
      setReady(await ollamaHealth());
      const m = await listModels();
      setModels(m);
      if (m.length && !m.find(x => x.model === model)) setModel(m[0].model);
    })();
  }, []);

  const onPull = async () => {
    setBusy(true);
    try {
      await pullModel(model);
      const m = await listModels();
      setModels(m);
    } finally {
      setBusy(false);
    }
  };

  const onSend = async () => {
    if (!prompt.trim()) return;
    setBusy(true);
    setAnswer("");
    try {
      const out = await generateText(model, prompt, 0.7, 4096);
      setAnswer(out);
    } finally {
      setBusy(false);
    }
  };

  return (
    <div style={{ padding: 16, fontFamily: "system-ui, sans-serif" }}>
      <h2>Proof â€” Local LLM</h2>
      <div>Status: {ready ? "Ollama ready" : "Starting Ollama..."}</div>
      <div style={{ marginTop: 12 }}>
        <label>Model:&nbsp;</label>
        <select value={model} onChange={e => setModel(e.target.value)}>
          {models.map(m => (
            <option key={m.model} value={m.model}>{m.model}</option>
          ))}
          {!models.find(m => m.model === "llama3.2:1b") && (
            <option value="llama3.2:1b">llama3.2:1b (pull to install)</option>
          )}
        </select>
        <button disabled={busy} onClick={onPull} style={{ marginLeft: 8 }}>Pull</button>
      </div>
      <div style={{ marginTop: 12 }}>
        <textarea rows={5} style={{ width: "100%" }} placeholder="Type a prompt..."
          value={prompt} onChange={e => setPrompt(e.target.value)} />
      </div>
      <div style={{ marginTop: 8 }}>
        <button disabled={busy} onClick={onSend}>Send</button>
      </div>
      <div style={{ marginTop: 16, whiteSpace: "pre-wrap" }}>
        {answer}
      </div>
    </div>
  );
}